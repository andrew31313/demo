---
- name: Ensure quagga configuration directory is moved to persistent storage
  file:
    path: /etc/network/quagga
    state: directory
    owner: quagga
    group: quaggavty
    mode: '0775'
  become: yes
- name: Ensure there is a link back to the expected location for quagga configs
  file:
    path: /etc/quagga
    src: /etc/network/quagga
    state: link
    force: yes
    owner: quagga
    group: quaggavty
    mode: '0775'
  become: yes
- name: Ensure zebra configuration is current
  template:
    dest: /etc/network/quagga/zebra.conf
    src: "zebra.conf.j2"
    owner: quagga
    group: quagga
    mode: '0644'
  notify: restart_zebra
  become: yes
- name: Ensure vtysh configuration is current
  template:
    dest: /etc/network/quagga/vtysh.conf
    src: "vtysh.conf.j2"
    owner: quagga
    group: quaggavty
    mode: '0644'
  become: yes
- name: Ensure ospfd configuration is current
  template:
    dest: /etc/network/quagga/ospfd.conf
    src: "ospfd.conf.j2"
    owner: quagga
    group: quagga
    mode: '0644'
  notify: restart_ospfd
  become: yes
- name: Ensure directories for runit support exist
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  loop:
    - "/etc/sv/zebra/log"
    - "/etc/sv/ospfd/log"
- name: Ensure /var/service is a link to default /etc/service location
  file:
    path: "/var/service"
    state: link
    src: "/etc/service"
  become: yes
- name: Ensure runit scripts for starting quagga services are installed
  template:
    src: runit_quagga.j2
    dest: "/etc/sv/{{ quagga_server }}/run"
    owner: root
    group: root
    mode: '0755'
  become: yes
  loop:
    - "zebra"
    - "ospfd"
  loop_control:
    loop_var: quagga_server
- name: Start zebra daemon
  service:
    name: "zebra"
    state: started
    enabled: yes
  become: yes
- name: Start OSPF daemon
  service:
    name: "ospfd"
    state: started
    enabled: yes
  become: yes
- name: Ensure isc-dhcp-relay is installed and configured if needed
  block:
    - name: Install isc-dhcp-relay
      apt:
        name: isc-dhcp-relay
        state: present
      become: yes
    - name: Configure isc-dhcp-relay
      template:
        src: isc-dhcp-relay.j2
        dest: /etc/default/isc-dhcp-relay
        owner: root
        group: root
        mode: '0644'
      become: yes
  when: isc_dhcp_relay is defined
