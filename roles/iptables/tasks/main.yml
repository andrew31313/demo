---
- name: Ensure iptables is configured and persists reboots
  block:
    - name: Ensure iptables is installed (Debian)
      apt:
        name: "{{ item }}"
        state: latest
      loop:
        - iptables
        - iptables-persistent
      become: yes
      when: ansible_distribution == 'Debian'
    - name: Ensure iptables is installed (Alpine)
      package:
        name: "{{ item }}"
        state: latest
      loop:
        - iptables
      become: yes
      when: ansible_distribution == 'Alpine'
    - name: Ensure iptables rules file exists
      template:
        dest: /etc/iptables/rules.v4
        src: iptables_rules.v4.j2
        owner: root
        group: root
        mode: '0644'
      become: yes
    - name: Ensure changes to firewall are always applied immediately (Debian)
      shell: /usr/sbin/iptables-restore < /etc/iptables/rules.v4
      changed_when: false
      become: yes
      when: ansible_distribution == 'Debian'
    - name: Ensure changes to firewall are always applied immediately (Alpine)
      shell: /sbin/iptables-restore < /etc/iptables/rules.v4
      changed_when: false
      become: yes
      when: ansible_distribution == 'Alpine'
    - name: Ensure persistent iptables rules get loaded at boot
      template:
        dest: /etc/network/if-pre-up.d/firewall
        src: firewall.j2
        owner: root
        group: root
        mode: "0755"
      become: yes
  when: fw is defined
