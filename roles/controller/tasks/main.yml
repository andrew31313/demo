---
- name: Ensure /ets/hosts contains static IPs for network gear
  lineinfile:
    path: /etc/hosts
    line: "{{ item.value.ansible_host }} {{ item.value.inventory_hostname }} {{ item.value.inventory_hostname_short }}"
  loop: "{{ hostvars | dict2items }}"
  become: yes
- name: Ensure apt cache is updated before installing packages
  apt:
    update_cache: yes
  become: yes
- name: Ensure iptables is installed
  apt:
    name: "{{ item }}"
    state: latest
  loop:
    - iptables
    - iptables-persistent
  become: yes
- name: Ensure NAT to Internet is enabled
  iptables:
    table: nat
    chain: POSTROUTING
    src_range: 192.168.42.1-192.168.42.254
    out_interface: eth1
    jump: MASQUERADE
  become: yes
- name: Ensure iptables rules persist across reboots
  template:
    dest: /etc/iptables/rules.v4
    src: iptables_rules.v4.j2
    owner: root
    group: root
    mode: '0644'
  become: yes
- name: Ensure persistent iptables rules get loaded
  template:
    dest: /etc/network/if-pre-up.d/firewall
    src: firewall.j2
    owner: root
    group: root
    mode: "0755"
  become: yes
- name: Ensure a .ssh directory exists for SSH keys
  file:
    path: "{{ ansible_user_dir }}/.ssh"
    state: directory
    mode: '0700'
- name: Ensure ssh key exists
  openssh_keypair:
    path: "{{ ansible_user_dir }}/.ssh/user"
    state: present
    comment: "user@networkplus.test"
