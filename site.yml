---
- name: Configure controler
  hosts: control.networkplus.test
  roles:
    - role: controller
    - role: system-packages
    - role: router
  tags:
    - controller
- name: Bootstrap network devices (1 - python)
  gather_facts: false
  hosts:
    - firewalls
    - routers
  roles:
    - role: bootstrap-python
  tags:
    - bootstrap_netdev
- name: Bootstrap network devices (2 - keys)
  hosts:
    - firewalls
    - routers
  roles:
    - role: bootstrap-keys
  tags:
    - bootstrap_netdev
# After bootstrapping, the network devices need to be cofigured from the
# outside to the inside as any device will depend on the devices between it
# and the Internet.
- name: Configure firewalls
  hosts: firewalls
  roles:
    - role: system-packages
    - role: nic
    - role: firewall
    - role: router
  tags:
    - firewall
- name: Configure routers
  hosts: routers
  roles:
    - role: system-packages
    - role: nic
    - role: router
  post_tasks:
    - name: Delay 60 seconds so new OSPF routers have time to share routes
      wait_for:
        timeout: 60
      delegate_to: localhost
  tags:
    - routers
# Once the network is up (and we wait it a pre_task for OSPF to converge,
# we can begin configuring the hosts.
- name: Bootstrap managed hosts (1 - python)
  gather_facts: false
  hosts: managed_hosts
  roles:
    - role: bootstrap-python
- name: Bootstrap managed hosts (2 - keys)
  hosts: managed_hosts
  roles:
    - role: bootstrap-keys
    - role: system-packages
- name: Configure dnsmasq servers
  hosts: dnsmasq_servers
  roles:
    - role: dnsmasq

