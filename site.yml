---
- name: Configure controler
  hosts: control.networkplus.test
  roles:
    - role: bootstrap
      control_host: true
      populate_hosts_file: true
    - role: nat
      nat_src_range: "192.168.42.1-192.168.42.254"
      nat_out_interface: "eth1"
    - role: router
  tags:
    - controller
- name: Bootstrap network devices (1 - python)
  gather_facts: false
  hosts:
    - firewalls
    - routers
  roles:
    - role: bootstrap-python
  tags:
    - bootstrap_netdev
- name: Bootstrap network devices (2 - keys)
  hosts:
    - firewalls
    - routers
  roles:
    - role: bootstrap
  tags:
    - bootstrap_netdev
# After bootstrapping, the network devices need to be cofigured from the
# outside to the inside as any device will depend on the devices between it
# and the Internet.
- name: Configure firewalls
  hosts: firewalls
  roles:
    - role: nic
    - role: nat
      nat_out_interface: "eth1"
    - role: router
  tags:
    - firewall
- name: Configure routers
  hosts: routers
  roles:
    - role: nic
    - role: router
  post_tasks:
    - name: Delay 60 seconds so new OSPF routers have time to share routes
      wait_for:
        timeout: 60
      delegate_to: localhost
  tags:
    - routers
# Once the network is up (and we wait it a pre_task for OSPF to converge,
# we can begin configuring the hosts.
- name: Bootstrap managed hosts (1 - python)
  gather_facts: false
  hosts: managed_hosts
  roles:
    - role: bootstrap-python
- name: Configure dnsmasq servers
  hosts: dnsmasq_servers
  roles:
    - role: bootstrap
      populate_hosts_file: true
    - role: dnsmasq
- name: Configure web servers
  hosts: web_servers
  roles:
    - role: bootstrap
    - role: webserver
