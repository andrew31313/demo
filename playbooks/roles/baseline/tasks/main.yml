---
- name: Ensure iputils is installed
  ansible.builtin.package:
    name: "{{ item }}"
    state: latest
  loop:
    - iputils
  become: yes
- name: Ensure iptables is configured and persists reboots
  block:
    - name: Ensure iptables is installed
      ansible.builtin.package:
        name: "{{ item }}"
        state: latest
      loop:
        - iptables
      become: yes
    - name: Ensure iptables rules file exists
      ansible.builtin.template:
        dest: /etc/iptables/rules.v4
        src: iptables_rules.v4.j2
        owner: root
        group: root
        mode: '0644'
      become: yes
    - name: Ensure changes to firewall are always applied immediately
      ansible.builtin.shell: /sbin/iptables-restore < /etc/iptables/rules.v4
      changed_when: false
      become: yes
    - name: Ensure persistent iptables rules get loaded at boot
      ansible.builtin.copy:
        dest: /etc/network/if-pre-up.d/firewall
        content: |
          #!/bin/bash
          if [ -f /etc/iptables/rules.v4 ]; then
            /sbin/iptables-restore < /etc/iptables/rules.v4
          fi
        owner: root
        group: root
        mode: "0755"
      become: yes
  when: fw is defined
