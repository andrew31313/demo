---
- name: Assert this host can use this role
  assert:
    that: ansible_distribution in supported_distributions
    fail_msg: "This role is not supported on your host operating system."
- name: Include OS specific variables
  include_vars: "{{ ansible_distribution | lower }}.yml"
- name: Check for homebrew installation on Mac
  stat:
    path: /usr/local/bin/brew
  register: brew
  changed_when: false
  when: ansible_distribution == "MacOSX"
- name: homebrew packages
  include_tasks: "system-packages-{{ ansible_distribution | lower }}-homebrew.yml"
  when: brew.stat is defined and brew.stat.exists
- name: Ensure {{ key_dir }} directory exists
  file:
    path: "{{ key_dir }}"
    state: directory
    mode: 0700
- name: Test if {{ key_dir }}/vagrant already installed
  stat:
    path: "{{ key_dir }}/vagrant"
  register: keys_installation
  changed_when: false
- name: Ensure key pair in {{ key_dir }}
  command: ssh-keygen -t rsa -b 4096 -f vagrant -N "" -C "vagrant public key created by vagrantbox setup"
  args:
    chdir: "{{ key_dir }}"
    creates: "{{ key_dir }}/vagrant"
  when: keys_installation.stat.isreg is not defined
- name: shell configuration
  include_tasks: "shell-config-{{ ansible_user_shell | basename }}.yml"
- name: system package tasks
  include_tasks: "system-packages-{{ ansible_distribution | lower }}.yml"
- name: packer tasks
  include_tasks: packer-check.yml
  tags:
    - disabled
- name: vagrant tasks
  include_tasks: vagrant-check.yml
  tags:
    - disabled
- name: virtualbox tasks
  include_tasks: virtualbox-check.yml
  tags:
    - disabled
