---
# ==============
# GNS3
# ==============
- name: Test if GNS3 is already installed
  stat:
    path: "{{ gns3_mac_plist }}"
  register: installed_gns3
  changed_when: false
- name: Check the version of GNS3 if already installed
  command: sed -n -e '/<key>CFBundleShortVersionString<\/key>/{n;s/^.*<string>\(.*\)<\/string>.*$/\1/;p;}' {{ gns3_mac_plist }}
  args:
    warn: false
  changed_when: false
  failed_when: false
  register: installed_gns3_version
  when: installed_gns3.stat.exists
- name: Download GNS3 disk image
  get_url:
    url: "{{ gns3_mac_dmg_url }}"
    dest: "{{ downloads }}/{{ gns3_mac_dmg }}"
    checksum: "{{ gns3_mac_dmg_checksum }}"
  when: installed_gns3.stat.exists is false or (installed_gns3_version.stdout != gns3_version)
- name: Mount the GNS3 disk image file
  command: hdiutil attach "{{ downloads }}/{{ gns3_mac_dmg }}"
  become: yes
  changed_when: false
  when: installed_gns3.stat.exists is false or (installed_gns3_version.stdout != gns3_version)
- name: Ensure previous version of GNS3 is removed if we are upgrading
  file:
    path: "{{ gns3_app }}"
    state: absent
  become: yes
  when: installed_gns3.stat.exists is true and (installed_gns3_version.stdout != gns3_version)
- name: Install GNS3.app
  command: cp -R "{{ gns3_mac_dmg_mount_path }}/GNS3.app" /Applications
  become: yes
  when: installed_gns3.stat.exists is false or (installed_gns3_version.stdout != gns3_version)
- name: Unmount the GNS3 disk image file
  command: hdiutil detach "{{ gns3_mac_dmg_mount_path }}"
  become: yes
  changed_when: false
  when: installed_gns3.stat.exists is false or (installed_gns3_version.stdout != gns3_version)
- name: Ensure ownership and mode of ubridge are correct
  file:
    path: "{{ gns3_app }}/Contents/MacOS/ubridge"
    owner: root
    mode: 04750
  become: yes
- name: Ensure user config directory for GNS3 exists
  file:
    path: "{{ ansible_user_dir }}/.config/GNS3"
    state: directory
    owner: "{{ ansible_user_id }}"
    group: staff
    mode: 0755
# ==============
# GNS3.VM.VirtualBox
# ==============
- name: Test if GNS3.VM.VirtualBox is already installed
  command: "VBoxManage showvminfo 'GNS3 VM'"
  register: installed_gns3vm
  changed_when: false
  failed_when: false
- name: Download the GNS3.VM.VirtualBox zip file
  get_url:
    url: "{{ gns3vm_vbox_zip_url }}"
    dest: "{{ downloads }}/{{ gns3vm_vbox_zip }}"
    checksum: "{{ gns3vm_vbox_zip_checksum }}"
  when: installed_gns3vm.rc != 0
- name: Unzip the GNS3.VM.VirtualBox zip file
  command: unzip -o -u {{ downloads }}/{{ gns3vm_vbox_zip }}
  args:
    chdir: "{{ downloads }}"
    warn: false
    creates: "{{ downloads }}/GNS3 VM.ova"
  when: installed_gns3vm.rc != 0
- name: Import GNS3.VM ova file into VirtualBox
  command: "VBoxManage import '{{ downloads }}/GNS3 VM.ova' --vsys 0 --vmname 'GNS3 VM'" 
  when: installed_gns3vm.rc != 0
# ==============
# Wireshark
# ==============
- name: Test if Wireshark is already installed
  stat:
    path: "{{ wireshark_app }}"
  register: installed_wireshark
  changed_when: false
  tags:
  - testing
- name: Check the version of Wireshark if already installed
  command: sed -n -e '/<key>CFBundleShortVersionString<\/key>/{n;s/^.*<string>\(.*\)<\/string>.*$/\1/;p;}' {{ wireshark_mac_plist }}
  args:
    warn: false
  changed_when: false
  failed_when: false
  register: installed_wireshark_version
  when: installed_wireshark.stat.exists
  tags:
  - testing
- name: Download wireshark disk image
  get_url:
    url: "{{ wireshark_mac_dmg_url }}"
    dest: "{{ downloads }}/{{ wireshark_mac_dmg }}"
    checksum: "{{ wireshark_mac_dmg_checksum }}"
  when: installed_wireshark.stat.exists is false or (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
- name: Mount the wireshark disk image file
  command: hdiutil attach "{{ downloads }}/{{ wireshark_mac_dmg }}"
  become: yes
  changed_when: false
  when: installed_wireshark.stat.exists is false or (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
- name: Ensure previous version of Wireshark is removed if we are upgrading
  file:
    path: "{{ wireshark_app }}"
    state: absent
  become: yes
  when: installed_wireshark.stat.exists is true and (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
- name: Install Wireshark.app
  command: cp -R "{{ wireshark_mac_dmg_mount_path }}/Wireshark.app" /Applications
  become: yes
  when: installed_wireshark.stat.exists is false or (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
- name: Install ChmodBPF
  command: installer -pkg "{{ wireshark_mac_dmg_mount_path }}/Install ChmodBPF.pkg" -target /
  become: yes
  ignore_errors: true
  when: installed_wireshark.stat.exists is false or (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
- name: Add Wireshark to system path
  command: installer -pkg "{{ wireshark_mac_dmg_mount_path }}/Add Wireshark to the system path.pkg" -target /
  become: yes
  ignore_errors: true
  when: installed_wireshark.stat.exists is false or (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
- name: Unmount wireshark image
  command: hdiutil detach "{{ wireshark_mac_dmg_mount_path }}"
  become: yes
  changed_when: false
  when: installed_wireshark.stat.exists is false or (installed_wireshark_version.stdout != wireshark_version)
  tags:
  - testing
