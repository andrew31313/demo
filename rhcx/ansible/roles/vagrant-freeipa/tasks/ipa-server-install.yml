---
# setsebool -P named_write_master_zones 1
# ausearch -c 'named-pkcs11' --raw | audit2allow -M my-namedpkcs11
# semodule -i my-namedpkcs11.pp
# ipactl status has return code of 4 when server is not configured
- name: Check the ipa-server-install install status
  command: ipactl status
  register: ipastatus
  changed_when: False
  failed_when: False
  become: yes
- name: Ensure IPA server is configured (takes several minutes if it isn't)
  command: ipa-server-install --setup-dns --allow-zone-overlap -U -p password -a password -n example.com -r EXAMPLE.COM --ip-address 192.168.4.200 --hostname labipa.example.com --reverse-zone 4.168.192.in-addr.arpa. --forwarder 8.8.8.8 -U 
  become: yes
  when: ipastatus.rc == 4
- name: Ensure A records for hosts exist
  shell: echo password | kinit admin; ipa dnsrecord-find {{ item.azone }} {{ item.ptr }} || echo | ipa dnsrecord-add {{ item.azone }} {{ item.ptr }} --a-ip-address 192.168.4.{{ item.a }}
  with_items:
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'labipa', a: '200' }
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'server1', a: '210' }
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'server2', a: '220' }
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'testnetinstall', a: '230' }
- name: Ensure PTR records for hosts exist
  shell: echo password | kinit admin; ipa dnsrecord-find {{ item.ptrzone }} {{ item.a }} || echo | ipa dnsrecord-add {{ item.ptrzone }} {{ item.a }} --ptr-hostname {{ item.ptr }}.example.com.
  with_items:
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'labipa', a: '200' }
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'server1', a: '210' }
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'server2', a: '220' }
    - { azone: 'example.com.', ptrzone: '4.168.192.in-addr.arpa', ptr: 'testnetinstall', a: '230' }
