---
- name: Test if vagrant is already installed
  stat:
    path: /usr/bin/vagrant
  register: vagrant_installation
  changed_when: False
- name: Download and install Vagrant rpm file
  package:
    name: "{{ vagrant_url }}"
    state: present
  when: vagrant_installation.stat.isreg is not defined
  become: yes
- name: Test if vagrant-libvirt plugin is already installed
  command: "vagrant plugin list"
  register: vagrant_plugin_installed
  changed_when: False
- name: Ensure gcc is installed in order to build the vagrant plugin
  package:
    name: "{{ item }}"
    state: present
  become: yes
  with_items:
    - gcc
    - libvirt-devel
    - make
  when: "'vagrant-libvirt' not in vagrant_plugin_installed.stdout"
- name: Install vagrant-libvirt plugin
  command: "vagrant plugin install vagrant-libvirt"
  when: "'vagrant-libvirt' not in vagrant_plugin_installed.stdout"
- name: Ensure {{ ansible_user_dir }}/keys directory exists
  file:
    path: "{{ ansible_user_dir }}/keys"
    state: directory
    mode: 0700
- name: Test if {{ ansible_user_dir }}/keys/vagrant already installed
  stat:
    path: "{{ ansible_user_dir }}/keys/vagrant"
  register: keys_installation
  changed_when: False
- name: Ensure key pair in {{ ansible_user_dir }}/keys
  command: ssh-keygen -t rsa -b 4096 -f vagrant -N "" -C "vagrant public key created by vagrantbox setup"
  args:
    chdir: "{{ ansible_user_dir }}/keys"
    creates: "{{ ansible_user_dir }}/keys/vagrant"
  when: keys_installation.stat.isreg is not defined
- name: NFS services
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  with_items:
    - firewalld
    - rpcbind
    - nfs-server
  become: yes
- name: Ensure NFS is allowed through firewall on libvirt interfaces (CentOS 8)
  firewalld:
    service: "{{ item }}"
    state: enabled
    permanent: yes
    immediate: yes
    zone: libvirt
  with_items:
    - rpc-bind
    - mountd
    - nfs
  become: yes
  when: ansible_distribution_major_version == "8"
- name: Ensure shared folders are exported
  copy:
    dest: /etc/exports.d/vagrant-shared-folders.exports
    content: "{{ ansible_user_dir }}/demo/rhcx/labfiles 192.168.4.*(rw)"
  become: yes
- name: Re-export shared folders
  command: exportfs -ra
  changed_when: false
  become: yes
