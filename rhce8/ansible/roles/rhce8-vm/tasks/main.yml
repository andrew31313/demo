---
- name: Ensure we accept distro GPG keys
  rpm_key:
    state: present
    key: "{{ item }}"
  become: yes
  loop: "{{ distro_gpg_keys }}"
- name: Ensure SELinux is in enforcing mode
  selinux:
    policy: targeted
    state: enforcing
  become: yes
  register: selinux
  notify: reboot
- name: Ensure SELinux fcontext policy updates have been configured
  sefcontext:
    target: "{{ item.target }}"
    setype: "{{ item.setype }}"
    state: "{{ item.state | default(omit) }}"
  become: yes
  when: sefcontext_updates is defined
  loop: "{{ sefcontext_updates }}"
  notify: serestorecon
- name: Ensure firewalld is started and enabled at boot
  service:
    name: firewalld
    state: started
    enabled: yes
  become: yes
- name: "Ensure firewall blocks {{ item.service }} in zone {{ item.zone }}"
  firewalld:
    service: "{{ item.service }}"
    state: disabled
    permanent: yes
    immediate: yes
    zone: "{{ item.zone }}"
  loop: "{{ firewall_service_disable }}"
  become: yes
- name: "Ensure firewall allows {{ item.service }} in zone {{ item.zone }}"
  firewalld:
    service: "{{ item.service }}"
    state: enabled
    permanent: yes
    immediate: yes
    zone: "{{ item.zone }}"
  loop: "{{ firewall_service_enable }}"
  become: yes
- name: Check if AccountsService is present
  stat:
    path: /var/lib/AccountsService
  register: accounts_service
  changed_when: False
- name: Ensure vagrant user is hidden from gdm login screen
  copy:
    src: vagrant
    dest: /var/lib/AccountsService/users
    mode: 0644
  become: yes
  when: accounts_service.stat.isdir is defined
- name: Ensure packages common to lab VMs are installed
  package:
    name: "{{ item }}"
    state: present
  loop: "{{ common_packages }}"
  become: yes
- name: Ensure local groups are present
  group:
    name: "{{ item.groupname }}"
    gid: "{{ item.gid | default(omit) }}"
    state: "{{ item.state | default(omit) }}"
    system: "{{ item.system | default(omit) }}"
  become: yes
  when: usergroups.local is defined
  loop: "{{ usergroups.local }}"
- name: Ensure local users are present
  user:
    name: "{{ item.username }}"
    append: "{{ item.append | default(omit) }}"
    comment: "{{ item.comment | default(omit) }}"
    create_home: "{{ item.create_home | default(omit) }}"
    group: "{{ item.group | default(omit) }}"
    groups: "{{ item.groups | default(omit) }}"
    home: "{{ item.home | default(omit) }}"
    password: "{{ item.pw | default(omit) }}"
    password_lock: "{{ item.password_lock | default(omit) }}"
    remove: "{{ item.remmove | default(omit) }}"
    shell: "{{ item.shell | default(omit) }}"
    state: "{{ item.state | default(omit) }}"
    system: "{{ item.system | default(omit) }}"
    uid: "{{ item.uid | default(omit) }}"
  become: yes
  when: users.local is defined
  loop: "{{ users.local }}"
- name: Ensure local directories exist
  file:
    path: "{{ item.path }}"
    state: directory
    group: "{{ item.group | default(omit) }}"
    mode: "{{ item.mode | default(omit) }}"
    owner: "{{ item.owner | default(omit) }}"
    setype: "{{ item.setype | default(omit) }}"
  become: yes
  when: dirs.local is defined
  loop: "{{ dirs.local }}"
- name: "Ensure {{ item.mountpoint.path }} mount point exists"
  file:
    path: "{{ item.mountpoint.path }}"
    state: directory
    owner: "{{ item.mountpoint.owner }}"
    group: "{{ item.mountpoint.group }}"
    mode: "{{ item.mountpoint.mode }}"
  become: yes
  when: remote_filesystems is defined
  loop: "{{ remote_filesystems }}"
- name: "Ensure {{ item.mountpoint.path }} will be remounted at boot"
  mount:
    path: "{{ item.mountpoint.path }}"
    src: "{{ item.src }}"
    fstype: "{{ item.fstype }}"
    opts: "{{ item.opts }}"
    state: present
    passno: "0"
    dump: "0"
  become: yes
  when: remote_filesystems is defined
  loop: "{{ remote_filesystems }}"
