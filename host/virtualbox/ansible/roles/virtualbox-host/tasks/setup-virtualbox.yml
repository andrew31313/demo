---
- name: Test if VirtualBox is already installed
  stat:
    path: "{{ virtualbox_plist }}"
  register: installed_virtualbox
  changed_when: false
- name: Check the version of VirtualBox if already installed
  command: sed -n -e '/CFBundleVersion/s/^.*<string>\(.*\)<\/string>.*$/\1/p' {{ virtualbox_plist }}
  args:
    warn: false
  changed_when: false
  failed_when: false
  register: installed_virtualbox_version
  when: installed_virtualbox.stat.exists
- name: Download VirtualBox disk image
  get_url:
    url: "{{ virtualbox_url }}"
    dest: "{{ downloads }}/{{ virtualbox_dmg }}"
    checksum: "{{ virtualbox_checksum }}"
  when: installed_virtualbox.stat.exists is false or (installed_virtualbox_version.stdout != virtualbox_version)
- name: Mount the VirtualBox disk image file
  command: hdiutil attach "{{ downloads }}/{{ virtualbox_dmg }}"
  become: yes
  changed_when: false
  when: installed_virtualbox.stat.exists is false or (installed_virtualbox_version.stdout != virtualbox_version)
- name: Install VirtualBox.pkg
  command: installer -pkg "{{ virtualbox_mount_path }}/VirtualBox.pkg" -target /
  become: yes
  when: installed_virtualbox.stat.exists is false or (installed_virtualbox_version.stdout != virtualbox_version)
- name: Unmount VirtualBox image
  command: hdiutil detach "{{ virtualbox_mount_path }}"
  become: yes
  changed_when: false
  when: installed_virtualbox.stat.exists is false or (installed_virtualbox_version.stdout != virtualbox_version)
